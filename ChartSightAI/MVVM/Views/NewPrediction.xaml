<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ChartSightAI.MVVM.Views.NewPrediction"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:Controls="clr-namespace:ChartSightAI.Controls"
    xmlns:vm="clr-namespace:ChartSightAI.MVVM.ViewModels"
    x:DataType="vm:NewPredictionVM"
    Background="{StaticResource Brush.BackgroundGradient}"
    Shell.NavBarIsVisible="False">

    <AbsoluteLayout>
        <Grid
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="All"
            RowDefinitions="Auto,*"
            RowSpacing="0">

            <!--  Top waves  -->
            <Grid
                Grid.Row="0"
                Margin="0,0,0,20"
                HeightRequest="200"
                WidthRequest="450"
                ZIndex="0">
                <Rectangle
                    Fill="{StaticResource Brush.HeaderGradient}"
                    HorizontalOptions="Fill"
                    VerticalOptions="Fill" />
                <Path
                    Aspect="Fill"
                    Data="M0,170 C160,210 320,130 480,170 C580,195 660,200 720,185 L720,220 L0,220 Z"
                    Fill="White"
                    HorizontalOptions="Fill"
                    Opacity="0.38"
                    VerticalOptions="End" />
            </Grid>

            <!--  Header content  -->
            <Border
                Grid.Row="0"
                Margin="24,0,24,8"
                Padding="0"
                Background="Transparent"
                StrokeThickness="0"
                ZIndex="10">

                <Grid
                    Padding="16,12"
                    ColumnDefinitions="Auto,*,Auto"
                    ColumnSpacing="12"
                    RowDefinitions="Auto,Auto">

                    <!--  Back button pill  -->
                    <Border
                        Grid.RowSpan="2"
                        Margin="0,0,10,0"
                        Padding="10"
                        Background="White"
                        HeightRequest="100"
                        StrokeShape="RoundRectangle 999"
                        StrokeThickness="0">
                        <Image
                            HeightRequest="40"
                            Source="logo.png"
                            WidthRequest="40">
                            <Image.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding CancelCommand}" />
                            </Image.GestureRecognizers>
                        </Image>
                    </Border>

                    <!--  Title  -->
                    <Label
                        Grid.Column="1"
                        StyleClass="h2"
                        Text="New Analysis Setup"
                        TextColor="{StaticResource TextDark}" />

                    <!--  Small chip  -->
                    <Border
                        Grid.Column="2"
                        Padding="10,4"
                        Background="White"
                        Opacity="0.92"
                        StrokeShape="RoundRectangle 999"
                        StrokeThickness="0"
                        VerticalOptions="Center">
                        <Label
                            StyleClass="caption"
                            Text="Step 1 of 1"
                            TextColor="{StaticResource TextLight}" />
                    </Border>

                    <!--  Subtitle  -->
                    <Label
                        Grid.Row="1"
                        Grid.Column="1"
                        Margin="0,2,0,0"
                        StyleClass="caption"
                        Text="Enter details and upload your chart to begin."
                        TextColor="{StaticResource TextLight}" />
                </Grid>
            </Border>

            <!--  Content  -->
            <ScrollView
                Grid.Row="1"
                Margin="0,0,0,70"
                Padding="15,0,15,24"
                VerticalScrollBarVisibility="Never">

                <StackLayout
                    HorizontalOptions="Center"
                    MaximumWidthRequest="720"
                    Spacing="10">

                    <!--  Market Type  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="6">
                            <Label StyleClass="h4" Text="Market Type" />
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                <Button
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Forex"
                                    StyleClass="na-chip"
                                    Text="Forex">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsForexSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Stocks"
                                    StyleClass="na-chip"
                                    Text="Stocks">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsStocksSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="2"
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Crypto"
                                    StyleClass="na-chip"
                                    Text="Crypto">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsCryptoSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Timeframe + Presets  -->
                    <Grid
                        Margin="0,0,0,8"
                        ColumnDefinitions=".53*,.47*"
                        ColumnSpacing="8">

                        <!--  Timeframe  -->
                        <Border
                            Grid.Column="0"
                            Padding="16,12"
                            Background="White"
                            Shadow="{StaticResource Sh.CardShadow}"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0">
                            <StackLayout Spacing="6">
                                <Label StyleClass="h4" Text="Chart Timeframe" />

                                <Grid
                                    ColumnDefinitions="*,*,*"
                                    RowDefinitions="Auto"
                                    RowSpacing="10">
                                    <Button
                                        Grid.Column="0"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Hour1"
                                        StyleClass="na-chip"
                                        Text="1H">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFH1}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>

                                    <Button
                                        Grid.Column="1"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Hour4"
                                        StyleClass="na-chip"
                                        Text="4H">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFH4}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>

                                    <Button
                                        Grid.Column="2"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Day1"
                                        StyleClass="na-chip"
                                        Text="1D">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFD1}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>
                                </Grid>

                                <Border Margin="0,8,0,0" StyleClass="na-field">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                        <Picker
                                            Title="Select Timeframe"
                                            ItemDisplayBinding="{Binding Label}"
                                            ItemsSource="{Binding TimeFrameChoices}"
                                            SelectedItem="{Binding SelectedTimeFrameOption, Mode=TwoWay}"
                                            StyleClass="na-picker" />
                                        <Label
                                            Grid.Column="1"
                                            Text="▾"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </StackLayout>
                        </Border>

                        <!--  Presets  -->
                        <Border
                            Grid.Column="1"
                            Padding="16,12"
                            Background="White"
                            Shadow="{StaticResource Sh.CardShadow}"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0">
                            <StackLayout Spacing="6">
                                <Label StyleClass="h4" Text="Presets" />
                                <Border Margin="0,8,0,0" StyleClass="na-field">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                        <Picker
                                            Title="Select preset"
                                            ItemDisplayBinding="{Binding Name}"
                                            ItemsSource="{Binding Presets}"
                                            SelectedItem="{Binding SelectedPreset, Mode=TwoWay}"
                                            StyleClass="na-picker" />
                                        <Label
                                            Grid.Column="1"
                                            Text="▾"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </StackLayout>
                        </Border>
                    </Grid>

                    <!--  Strategy Focus  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="6">
                            <Label StyleClass="h4" Text="Strategy Focus" />
                            <Grid
                                ColumnDefinitions="*,*,*"
                                ColumnSpacing="8"
                                RowSpacing="8">
                                <Button
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="Technical"
                                    StyleClass="na-chip"
                                    Text="Technical">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsTechnicalSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="Pattern"
                                    StyleClass="na-chip"
                                    Text="Pattern">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsPatternSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="2"
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="AI"
                                    StyleClass="na-chip"
                                    Text="AI Prediction">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsAiSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Trade Direction  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="6">
                            <Label StyleClass="h4" Text="Trade Direction" />
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                                <Button
                                    Command="{Binding SetTradeDirectionFromStringCommand}"
                                    CommandParameter="Long"
                                    StyleClass="na-chip"
                                    Text="Long Trade">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsLongSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding SetTradeDirectionFromStringCommand}"
                                    CommandParameter="Short"
                                    StyleClass="na-chip"
                                    Text="Short Trade">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsShortSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Upload  -->
                    <Border StyleClass="na-dropzone">
                        <Grid
                            ColumnDefinitions="Auto,*"
                            ColumnSpacing="12"
                            RowDefinitions="Auto,Auto">
                            <Border
                                Grid.Row="0"
                                Grid.Column="0"
                                StrokeShape="RoundRectangle 999"
                                StrokeThickness="0"
                                VerticalOptions="Center">
                                <Image
                                    HeightRequest="50"
                                    IsAnimationPlaying="True"
                                    Source="search.gif"
                                    WidthRequest="50" />
                            </Border>

                            <VerticalStackLayout
                                Grid.Row="0"
                                Grid.Column="1"
                                Spacing="2"
                                VerticalOptions="Center">
                                <Label Text="Upload chart image or take a photo" />
                                <Label
                                    StyleClass="caption"
                                    Text="Tap to upload"
                                    TextDecorations="Underline">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </VerticalStackLayout>

                            <Border
                                Grid.Row="1"
                                Grid.ColumnSpan="2"
                                Margin="0,12,0,0"
                                Padding="0"
                                Background="{StaticResource CardBg}"
                                StrokeShape="RoundRectangle 16"
                                StrokeThickness="0">
                                <Grid>
                                    <!--  Placeholder  -->
                                    <Grid x:Name="Placeholder" Padding="16">
                                        <VerticalStackLayout
                                            HorizontalOptions="Center"
                                            Spacing="10"
                                            VerticalOptions="Center">
                                            <Image
                                                HeightRequest="120"
                                                HorizontalOptions="Center"
                                                IsAnimationPlaying="True"
                                                Source="bankruptcy.gif" />
                                            <Label
                                                HorizontalTextAlignment="Center"
                                                StyleClass="caption"
                                                Text="No chart selected. Tap the card to upload." />
                                        </VerticalStackLayout>
                                        <Grid.Triggers>
                                            <DataTrigger
                                                Binding="{Binding HasPreview}"
                                                TargetType="Grid"
                                                Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Grid.Triggers>
                                    </Grid>

                                    <!--  Preview  -->
                                    <Image
                                        x:Name="Preview"
                                        Aspect="AspectFill"
                                        HeightRequest="180"
                                        Source="{Binding PreviewImagePath}">
                                        <Image.Triggers>
                                            <DataTrigger
                                                Binding="{Binding HasPreview}"
                                                TargetType="Image"
                                                Value="False">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                </Grid>
                            </Border>
                        </Grid>

                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                        </Border.GestureRecognizers>
                    </Border>

                    <!--  CTA  -->
                    <Grid
                        Margin="0,24,0,0"
                        ColumnDefinitions="*,*"
                        ColumnSpacing="16">
                        <Button
                            Command="{Binding AnalyzeChartCommand}"
                            StyleClass="na-cta"
                            Text="Analyze Chart" />
                        <Button
                            Grid.Column="1"
                            Command="{Binding CancelCommand}"
                            StyleClass="na-cta"
                            Text="Cancel" />
                    </Grid>
                </StackLayout>
            </ScrollView>
        </Grid>

        <!--  Floating TabBar  -->
        <Controls:TABBAR
            Margin="0,0,0,20"
            AbsoluteLayout.LayoutBounds="0.5,1,1,76"
            AbsoluteLayout.LayoutFlags="PositionProportional,WidthProportional"
            ZIndex="1000" />
    </AbsoluteLayout>
</ContentPage>
