<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ChartSightAI.MVVM.Views.NewPrediction"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:Controls="clr-namespace:ChartSightAI.Controls"
    xmlns:vm="clr-namespace:ChartSightAI.MVVM.ViewModels"
    x:DataType="vm:NewPredictionVM"
    Background="{StaticResource Brush.BackgroundGradient}"
    Shell.NavBarIsVisible="False">

    <AbsoluteLayout>
        <Grid
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="All"
            RowDefinitions="Auto,*"
            RowSpacing="0">

            <!--  Header  -->
            <Border
                Grid.Row="0"
                Margin="24,20,24,12"
                Padding="16,12"
                Background="White"
                Shadow="{StaticResource Sh.CardShadow}"
                StrokeShape="RoundRectangle 30"
                StrokeThickness="0">
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                    <Image
                        HeightRequest="40"
                        IsAnimationPlaying="True"
                        Source="analyse.gif"
                        VerticalOptions="Center"
                        WidthRequest="40" />
                    <VerticalStackLayout
                        Grid.Column="1"
                        Spacing="2"
                        VerticalOptions="Center">
                        <Label StyleClass="h2" Text="New Analysis Setup" />
                        <Label StyleClass="caption" Text="Enter details and upload your chart to begin." />
                    </VerticalStackLayout>
                </Grid>
            </Border>

            <!--  Content  -->
            <ScrollView
                Grid.Row="1"
                Margin="0,0,0,70"
                Padding="15,0,15,24">
                <StackLayout
                    HorizontalOptions="Center"
                    MaximumWidthRequest="720"
                    Spacing="5">

                    <!--  Market Type Section  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="4">
                            <!--  Reduced Spacing  -->
                            <Label StyleClass="h4" Text="Market Type" />
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                <Button
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Forex"
                                    StyleClass="na-chip"
                                    Text="Forex">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsForexSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Stocks"
                                    StyleClass="na-chip"
                                    Text="Stock Market">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsStocksSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="2"
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Crypto"
                                    StyleClass="na-chip"
                                    Text="Crypto">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsCryptoSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Timeframe and Preset Section (Side-by-side)  -->
                    <Grid
                        Margin="0,0,0,8"
                        ColumnDefinitions="*, Auto"
                        ColumnSpacing="8">
                        <!--  Chart Timeframe Section  -->
                        <Border
                            Grid.Column="0"
                            Padding="16,12"
                            Background="White"
                            Shadow="{StaticResource Sh.CardShadow}"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0">
                            <StackLayout>
                                <!--  Reduced Spacing  -->
                                <Label StyleClass="h4" Text="Chart Timeframe" />

                                <!--  Quick timeframe chips (stay visible for all markets)  -->
                                <Grid
                                    ColumnDefinitions="*,*,*"
                                    RowDefinitions="Auto"
                                    RowSpacing="10">
                                    <Button
                                        Grid.Column="0"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Hour1"
                                        StyleClass="na-chip"
                                        Text="1H">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFH1}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>

                                    <Button
                                        Grid.Column="1"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Hour4"
                                        StyleClass="na-chip"
                                        Text="4H">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFH4}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>

                                    <Button
                                        Grid.Column="2"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Day1"
                                        StyleClass="na-chip"
                                        Text="1D">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFD1}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>
                                </Grid>

                                <!--  Main TimeFrame Picker (pretty labels)  -->
                                <Border Margin="0,8,0,0" StyleClass="na-field">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                        <Picker
                                            Title="Select Timeframe"
                                            ItemDisplayBinding="{Binding Label}"
                                            ItemsSource="{Binding TimeFrameChoices}"
                                            SelectedItem="{Binding SelectedTimeFrameOption, Mode=TwoWay}"
                                            StyleClass="na-picker" />
                                        <Label
                                            Grid.Column="1"
                                            Text="▾"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </StackLayout>
                        </Border>

                        <!--  Indicator Preset Section  -->
                        <Border
                            Grid.Column="1"
                            Padding="16,12"
                            Background="White"
                            Shadow="{StaticResource Sh.CardShadow}"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0">
                            <StackLayout Spacing="4">
                                <!--  Reduced Spacing  -->
                                <Label StyleClass="h4" Text="Presets      " />
                                <Border Margin="0,15,0,0" StyleClass="na-field">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                        <Picker
                                            Title="Select preset"
                                            FontAutoScalingEnabled="True"
                                            ItemDisplayBinding="{Binding Name}"
                                            ItemsSource="{Binding Presets}"
                                            SelectedItem="{Binding SelectedPreset, Mode=TwoWay}"
                                            StyleClass="na-picker" />


                                        <Label
                                            Grid.Column="1"
                                            Text="▾"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </StackLayout>
                        </Border>
                    </Grid>

                    <!--  Strategy Focus Section  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="4">
                            <!--  Reduced Spacing  -->
                            <Label StyleClass="h4" Text="Strategy Focus" />
                            <Grid
                                ColumnDefinitions="*,*,*"
                                ColumnSpacing="8"
                                RowSpacing="8">
                                <Button
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="Technical"
                                    StyleClass="na-chip"
                                    Text="Technical">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsTechnicalSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="Pattern"
                                    StyleClass="na-chip"
                                    Text="Pattern">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsPatternSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="2"
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="AI"
                                    StyleClass="na-chip"
                                    Text="AI Prediction">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsAiSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Trade Direction Section  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="4">
                            <!--  Reduced Spacing  -->
                            <Label StyleClass="h4" Text="Trade Direction" />
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                                <Button
                                    Command="{Binding SetTradeDirectionFromStringCommand}"
                                    CommandParameter="Long"
                                    StyleClass="na-chip"
                                    Text="Long Trade">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsLongSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding SetTradeDirectionFromStringCommand}"
                                    CommandParameter="Short"
                                    StyleClass="na-chip"
                                    Text="Short Trade">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsShortSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Upload Section  -->
                    <Border StyleClass="na-dropzone">
                        <Grid
                            ColumnDefinitions="Auto,*"
                            ColumnSpacing="12"
                            RowDefinitions="Auto,Auto">

                            <!--  Row 0: header + tap  -->
                            <Border
                                Grid.Row="0"
                                Grid.Column="0"
                                StrokeShape="RoundRectangle 999"
                                StrokeThickness="0"
                                VerticalOptions="Center">
                                <Image
                                    HeightRequest="50"
                                    IsAnimationPlaying="True"
                                    Source="search.gif"
                                    WidthRequest="50" />
                            </Border>

                            <VerticalStackLayout
                                Grid.Row="0"
                                Grid.Column="1"
                                Spacing="2"
                                VerticalOptions="Center">
                                <Label Text="Upload chart image or take a photo" />
                                <Label
                                    StyleClass="caption"
                                    Text="Tap to upload"
                                    TextDecorations="Underline">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </VerticalStackLayout>

                            <!--  Row 1: preview area  -->
                            <Border
                                Grid.Row="1"
                                Grid.ColumnSpan="2"
                                Margin="0,12,0,0"
                                Padding="0"
                                Background="{StaticResource CardBg}"
                                StrokeShape="RoundRectangle 16"
                                StrokeThickness="0">
                                <Grid>
                                    <!--  Placeholder animation (shown when NO image yet)  -->
                                    <Grid x:Name="Placeholder" Padding="16">
                                        <VerticalStackLayout
                                            HorizontalOptions="Center"
                                            Spacing="10"
                                            VerticalOptions="Center">
                                            <!--  replace upload_placeholder.gif with your animation  -->
                                            <Image
                                                HeightRequest="120"
                                                HorizontalOptions="Center"
                                                IsAnimationPlaying="True"
                                                Source="bankruptcy.gif" />
                                            <Label
                                                HorizontalTextAlignment="Center"
                                                StyleClass="caption"
                                                Text="No chart selected. Tap the card to upload." />
                                        </VerticalStackLayout>
                                        <Grid.Triggers>
                                            <DataTrigger
                                                Binding="{Binding HasPreview}"
                                                TargetType="Grid"
                                                Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Grid.Triggers>
                                    </Grid>

                                    <!--  Actual preview (shown when image selected)  -->
                                    <Image
                                        x:Name="Preview"
                                        Aspect="AspectFill"
                                        HeightRequest="180"
                                        Source="{Binding PreviewImagePath}">
                                        <Image.Triggers>
                                            <DataTrigger
                                                Binding="{Binding HasPreview}"
                                                TargetType="Image"
                                                Value="False">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>

                                </Grid>
                            </Border>
                        </Grid>

                        <!--  Tap anywhere in the dropzone too  -->
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                        </Border.GestureRecognizers>
                    </Border>
                    <!--  CTA Section (No Border)  -->
                    <Grid
                        Margin="0,24,0,0"
                        ColumnDefinitions="*,*"
                        ColumnSpacing="16">
                        <Button
                            Command="{Binding AnalyzeChartCommand}"
                            StyleClass="na-cta"
                            Text="Analyze Chart" />
                        <Button
                            Grid.Column="1"
                            Command="{Binding CancelCommand}"
                            StyleClass="na-cta"
                            Text="Cancel" />
                    </Grid>
                </StackLayout>
            </ScrollView>
        </Grid>

        <!--  Floating TabBar  -->
        <Controls:TABBAR
            Margin="0,0,0,20"
            AbsoluteLayout.LayoutBounds="0.5,1,1,76"
            AbsoluteLayout.LayoutFlags="PositionProportional,WidthProportional"
            ZIndex="1000" />
    </AbsoluteLayout>
</ContentPage>