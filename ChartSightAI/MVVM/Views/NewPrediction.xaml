<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ChartSightAI.MVVM.Views.NewPrediction"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:Controls="clr-namespace:ChartSightAI.Controls"
    xmlns:bottomSheet="clr-namespace:Syncfusion.Maui.Toolkit.BottomSheet;assembly=Syncfusion.Maui.Toolkit"
    xmlns:conv="clr-namespace:ChartSightAI.Converters"
    xmlns:models="clr-namespace:ChartSightAI.MVVM.Models"
    xmlns:shapes="clr-namespace:Microsoft.Maui.Controls.Shapes;assembly=Microsoft.Maui.Controls"
    xmlns:vm="clr-namespace:ChartSightAI.MVVM.ViewModels"
    x:DataType="vm:NewPredictionVM"
    Background="{StaticResource Brush.BackgroundGradient}"
    Shell.NavBarIsVisible="False">
    <ContentPage.Resources>
        <conv:ConfidenceToBrushConverter
            x:Key="ConfidenceToBrush"
            HighBrush="{StaticResource Primary}"
            LowBrush="{StaticResource Muted}"
            MidBrush="{StaticResource Warn}" />
    </ContentPage.Resources>
    <AbsoluteLayout>

        <!--  ========= MAIN CONTENT =========  -->
        <Grid
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="All"
            RowDefinitions="Auto,*"
            RowSpacing="0">
            <!--  Top wave background (behind header + content)  -->
            <Grid Grid.Row="0" HeightRequest="240">
                <!--  Wave 1  -->
                <shapes:Path
                    Aspect="Fill"
                    Data="M0,0 L0,160 Q180,210 360,160 T720,160 L720,0 Z"
                    Fill="{StaticResource Brush.HeaderGradient}"
                    HorizontalOptions="Fill"
                    InputTransparent="True"
                    Opacity="1"
                    VerticalOptions="Fill" />

                <!--  Subtle overlay wave for depth  -->
                <shapes:Path
                    Aspect="Fill"
                    Data="M0,0 L0,175 Q180,225 360,175 T720,175 L720,0 Z"
                    Fill="White"
                    HorizontalOptions="Fill"
                    InputTransparent="True"
                    Opacity="0.12"
                    VerticalOptions="Fill" />
            </Grid>


            <Border
                Grid.Row="0"
                Margin="24,20,24,12"
                Padding="0"
                Background="{StaticResource Brush.HeaderGradient}"
                HeightRequest="120"
                Shadow="{StaticResource Sh.CardShadow}"
                StrokeShape="RoundRectangle 28"
                StrokeThickness="0"
                VerticalOptions="Start">

                <Grid
                    Padding="16,14"
                    ColumnDefinitions="Auto,*,Auto"
                    ColumnSpacing="12"
                    RowDefinitions="Auto,Auto">

                    <!--  Brand pill (standard: 56x88)  -->
                    <Border
                        Grid.RowSpan="2"
                        Margin="0,0,12,0"
                        Padding="12"
                        Background="White"
                        HeightRequest="88"
                        Opacity="0.95"
                        StrokeShape="RoundRectangle 999"
                        StrokeThickness="0"
                        VerticalOptions="Center"
                        WidthRequest="56">
                        <Image
                            HeightRequest="28"
                            Source="logo.png"
                            WidthRequest="28" />
                    </Border>

                    <!--  Title  -->
                    <Label
                        Grid.Column="1"
                        Margin="0,2,0,0"
                        LineBreakMode="WordWrap"
                        MaxLines="2"
                        StyleClass="h2"
                        Text="New Analysis Setup"
                        TextColor="{StaticResource TextDark}" />

                    <!--  Step pill (compact, consistent height)  -->
                    <Border
                        Grid.Column="2"
                        Padding="10,4"
                        Background="White"
                        HeightRequest="32"
                        Opacity="0.95"
                        StrokeShape="RoundRectangle 999"
                        StrokeThickness="0"
                        VerticalOptions="Start">
                        <HorizontalStackLayout Spacing="6" VerticalOptions="Center">
                            <Label
                                StyleClass="caption"
                                Text="Step"
                                TextColor="{StaticResource TextLight}" />
                            <Label
                                FontAttributes="Bold"
                                Text="1 of 1"
                                TextColor="{StaticResource TextDark}" />
                        </HorizontalStackLayout>
                    </Border>

                    <!--  Subtitle  -->
                    <Label
                        Grid.Row="1"
                        Grid.Column="1"
                        Margin="0,4,0,0"
                        LineBreakMode="TailTruncation"
                        MaxLines="1"
                        StyleClass="caption"
                        Text="Enter your details"
                        TextColor="{StaticResource TextLight}" />
                </Grid>
            </Border>




            <!--  Content  -->
            <ScrollView
                Grid.Row="1"
                Margin="0,0,0,70"
                Padding="15,0,15,24"
                VerticalScrollBarVisibility="Never">

                <StackLayout
                    HorizontalOptions="Center"
                    MaximumWidthRequest="720"
                    Spacing="10">

                    <!--  Market Type  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="6">
                            <Label StyleClass="h4" Text="Market Type" />
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                <Button
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Forex"
                                    StyleClass="na-chip"
                                    Text="Forex">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsForexSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Stocks"
                                    StyleClass="na-chip"
                                    Text="Stocks">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsStocksSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="2"
                                    Command="{Binding SetMarketTypeFromStringCommand}"
                                    CommandParameter="Crypto"
                                    StyleClass="na-chip"
                                    Text="Crypto">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsCryptoSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Timeframe + Presets  -->
                    <Grid
                        Margin="0,0,0,8"
                        ColumnDefinitions=".53*,.47*"
                        ColumnSpacing="8">

                        <!--  Timeframe  -->
                        <Border
                            Grid.Column="0"
                            Padding="16,12"
                            Background="White"
                            Shadow="{StaticResource Sh.CardShadow}"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0">
                            <StackLayout Spacing="6">
                                <Label StyleClass="h4" Text="Chart Timeframe" />

                                <Grid
                                    ColumnDefinitions="*,*,*"
                                    RowDefinitions="Auto"
                                    RowSpacing="10">
                                    <Button
                                        Grid.Column="0"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Hour1"
                                        StyleClass="na-chip"
                                        Text="1H">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFH1}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>

                                    <Button
                                        Grid.Column="1"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Hour4"
                                        StyleClass="na-chip"
                                        Text="4H">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFH4}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>

                                    <Button
                                        Grid.Column="2"
                                        Command="{Binding SetTimeFrameFromStringCommand}"
                                        CommandParameter="Day1"
                                        StyleClass="na-chip"
                                        Text="1D">
                                        <Button.Triggers>
                                            <DataTrigger
                                                Binding="{Binding IsTFD1}"
                                                TargetType="Button"
                                                Value="True">
                                                <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                                <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                                <Setter Property="TextColor" Value="White" />
                                                <Setter Property="BorderWidth" Value="0" />
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>
                                </Grid>

                                <Border Margin="0,8,0,0" StyleClass="na-field">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                        <Picker
                                            Title="Select Timeframe"
                                            ItemDisplayBinding="{Binding Label}"
                                            ItemsSource="{Binding TimeFrameChoices}"
                                            SelectedItem="{Binding SelectedTimeFrameOption, Mode=TwoWay}"
                                            StyleClass="na-picker" />
                                        <Label
                                            Grid.Column="1"
                                            Text="▾"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </StackLayout>
                        </Border>

                        <!--  Presets  -->
                        <Border
                            Grid.Column="1"
                            Padding="16,12"
                            Background="White"
                            Shadow="{StaticResource Sh.CardShadow}"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0">
                            <StackLayout Spacing="6">
                                <Label StyleClass="h4" Text="Presets" />
                                <Border Margin="0,8,0,0" StyleClass="na-field">
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                        <Picker
                                            Title="Select Preset"
                                            Background="Transparent"
                                            ItemDisplayBinding="{Binding Name}"
                                            ItemsSource="{Binding Presets}"
                                            SelectedItem="{Binding SelectedPreset, Mode=TwoWay}"
                                            StyleClass="na-picker" />
                                        <Label
                                            Grid.Column="1"
                                            Text="▾"
                                            VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </StackLayout>
                        </Border>
                    </Grid>

                    <!--  Strategy Focus  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="6">
                            <Label StyleClass="h4" Text="Strategy Focus" />
                            <Grid
                                ColumnDefinitions="*,*,*"
                                ColumnSpacing="8"
                                RowSpacing="8">
                                <Button
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="Technical"
                                    StyleClass="na-chip"
                                    Text="Technical">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsTechnicalSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="Pattern"
                                    StyleClass="na-chip"
                                    Text="Pattern">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsPatternSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="2"
                                    Command="{Binding ToggleStrategyFocusCommand}"
                                    CommandParameter="AI"
                                    StyleClass="na-chip"
                                    Text="AI Prediction">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsAiSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Trade Direction  -->
                    <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="White"
                        Shadow="{StaticResource Sh.CardShadow}"
                        StrokeShape="RoundRectangle 20"
                        StrokeThickness="0">
                        <StackLayout Spacing="6">
                            <Label StyleClass="h4" Text="Trade Direction" />
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                                <Button
                                    Command="{Binding SetTradeDirectionFromStringCommand}"
                                    CommandParameter="Long"
                                    StyleClass="na-chip"
                                    Text="Long Trade">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsLongSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>

                                <Button
                                    Grid.Column="1"
                                    Command="{Binding SetTradeDirectionFromStringCommand}"
                                    CommandParameter="Short"
                                    StyleClass="na-chip"
                                    Text="Short Trade">
                                    <Button.Triggers>
                                        <DataTrigger
                                            Binding="{Binding IsShortSelected}"
                                            TargetType="Button"
                                            Value="True">
                                            <Setter Property="Background" Value="{StaticResource Brush.ButtonGradient}" />
                                            <Setter Property="BorderColor" Value="{StaticResource Primary}" />
                                            <Setter Property="TextColor" Value="White" />
                                            <Setter Property="BorderWidth" Value="0" />
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                            </Grid>
                        </StackLayout>
                    </Border>

                    <!--  Upload  -->
                    <Border StyleClass="na-dropzone">
                        <Grid
                            ColumnDefinitions="Auto,*"
                            ColumnSpacing="12"
                            RowDefinitions="Auto,Auto">
                            <Border
                                Grid.Row="0"
                                Grid.Column="0"
                                StrokeShape="RoundRectangle 999"
                                StrokeThickness="0"
                                VerticalOptions="Center">
                                <Image
                                    HeightRequest="50"
                                    IsAnimationPlaying="True"
                                    Source="search.png"
                                    WidthRequest="50" />
                            </Border>

                            <VerticalStackLayout
                                Grid.Row="0"
                                Grid.Column="1"
                                Spacing="2"
                                VerticalOptions="Center">
                                <Label Text="Upload chart image or take a photo" />
                                <Label
                                    StyleClass="caption"
                                    Text="Tap to upload"
                                    TextDecorations="Underline">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </VerticalStackLayout>

                            <Border
                                Grid.Row="1"
                                Grid.ColumnSpan="2"
                                Margin="0,12,0,0"
                                Padding="0"
                                Background="{StaticResource CardBg}"
                                StrokeShape="RoundRectangle 16"
                                StrokeThickness="0">
                                <Grid>
                                    <!--  Placeholder  -->
                                    <Grid x:Name="Placeholder" Padding="16">
                                        <VerticalStackLayout
                                            HorizontalOptions="Center"
                                            Spacing="10"
                                            VerticalOptions="Center">
                                            <Image
                                                HeightRequest="120"
                                                HorizontalOptions="Center"
                                                IsAnimationPlaying="True"
                                                Source="growth.gif" />
                                            <Label
                                                HorizontalTextAlignment="Center"
                                                StyleClass="caption"
                                                Text="No chart selected. Tap the card to upload." />
                                        </VerticalStackLayout>
                                        <Grid.Triggers>
                                            <DataTrigger
                                                Binding="{Binding HasPreview}"
                                                TargetType="Grid"
                                                Value="True">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Grid.Triggers>
                                    </Grid>

                                    <!--  Preview  -->
                                    <Image
                                        x:Name="Preview"
                                        Aspect="AspectFill"
                                        HeightRequest="180"
                                        Source="{Binding PreviewImagePath}">
                                        <Image.Triggers>
                                            <DataTrigger
                                                Binding="{Binding HasPreview}"
                                                TargetType="Image"
                                                Value="False">
                                                <Setter Property="IsVisible" Value="False" />
                                            </DataTrigger>
                                        </Image.Triggers>
                                    </Image>
                                </Grid>
                            </Border>
                        </Grid>

                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding UploadImageCommand}" />
                        </Border.GestureRecognizers>
                    </Border>

                    <!--  CTA  -->
                    <Grid
                        Margin="0,24,0,0"
                        ColumnDefinitions="*,*"
                        ColumnSpacing="16">
                        <Button
                            Command="{Binding AnalyzeChartCommand}"
                            StyleClass="na-cta"
                            Text="Analyze Chart" />
                        <Button
                            Grid.Column="1"
                            Command="{Binding CancelCommand}"
                            StyleClass="na-cta"
                            Text="Cancel" />
                    </Grid>
                </StackLayout>
            </ScrollView>
            <!--  ========= AI ANALYSIS BOTTOM SHEET (sticky actions, guaranteed visible) =========  -->
            <bottomSheet:SfBottomSheet
                x:Name="AiSheet"
                Grid.RowSpan="2"
                AllowedState="All"
                Background="#F8FFFF"
                CollapsedHeight="160"
                ContentPadding="0"
                CornerRadius="28"
                FullExpandedRatio="0.96"
                GrabberAreaHeight="18"
                GrabberBackground="{StaticResource Primary}"
                GrabberWidth="56"
                HalfExpandedRatio="0.64"
                IsModal="True"
                IsOpen="{Binding IsAiSheetOpen}"
                ShowGrabber="True"
                State="FullExpanded"
                ZIndex="4000">

                <bottomSheet:SfBottomSheet.BottomSheetContent>

                    <!--  2 rows: Header + Content. Actions are overlaid as the LAST child (RowSpan=2).  -->
                    <Grid Padding="16,10,16,16" RowDefinitions="Auto,*">

                        <!--  Header  -->
                        <Border StyleClass="ai-sheet-header">
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                <Label
                                    Grid.Row="0"
                                    StyleClass="h2"
                                    Text="AI Analysis"
                                    TextColor="{StaticResource TextDark}" />
                                <Button
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Command="{Binding CloseAiSheetCommand}"
                                    StyleClass="ai-cta-secondary"
                                    Text="Close" />
                                <Label
                                    Grid.Row="1"
                                    StyleClass="ai-caption"
                                    Text="Automated insights using your selected market &amp; timeframe." />
                            </Grid>
                        </Border>

                        <!--  Scrollable body (leave space at bottom so content never hides behind the dock)  -->
                        <ScrollView Grid.Row="1" VerticalScrollBarVisibility="Never">
                            <Grid
                                Margin="0,6,0,120"
                                ColumnDefinitions="*,*"
                                ColumnSpacing="12"
                                RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto"
                                RowSpacing="12">
                                <!--  Summary  -->
                                <Border Grid.ColumnSpan="2" StyleClass="ai-card">
                                    <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Border StyleClass="ai-iconchip">
                                                <Path Data="M4,4 H20 V16 H9 L6,19 V16 H4 Z" StyleClass="ai-icon" />
                                            </Border>
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="h4 ai-section-title"
                                                Text="Summary" />
                                        </Grid>
                                        <Label
                                            Grid.Row="1"
                                            StyleClass="ai-body"
                                            Text="{Binding Analysis.Summary}" />
                                    </Grid>
                                </Border>

                                <!--  Trend  -->
                                <Border
                                    Grid.Row="1"
                                    Grid.Column="0"
                                    StyleClass="ai-card">
                                    <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Border StyleClass="ai-iconchip">
                                                <Path Data="M3,17 L11,9 L14,12 L21,5" StyleClass="ai-icon" />
                                            </Border>
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="h4 ai-section-title"
                                                Text="Trend Analysis" />
                                        </Grid>
                                        <Label
                                            Grid.Row="1"
                                            StyleClass="ai-body"
                                            Text="{Binding Analysis.TrendAnalysis}" />
                                    </Grid>
                                </Border>

                                <!--  Pattern  -->
                                <Border
                                    Grid.Row="1"
                                    Grid.Column="1"
                                    StyleClass="ai-card">
                                    <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Border StyleClass="ai-iconchip">
                                                <Path Data="M12,4 L20,18 H4 Z" StyleClass="ai-icon" />
                                            </Border>
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="h4 ai-section-title"
                                                Text="Pattern Detected" />
                                        </Grid>
                                        <Label
                                            Grid.Row="1"
                                            StyleClass="ai-body"
                                            Text="{Binding Analysis.Pattern}" />
                                    </Grid>
                                </Border>

                                <!--  Support & Resistance  -->
                                <Border
                                    Grid.Row="2"
                                    Grid.ColumnSpan="2"
                                    StyleClass="ai-card">
                                    <Grid RowDefinitions="Auto,Auto" RowSpacing="8">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Border StyleClass="ai-iconchip">
                                                <Path Data="M4,8 H20 M4,14 H20" StyleClass="ai-icon" />
                                            </Border>
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="h4 ai-section-title"
                                                Text="Support &amp; Resistance" />
                                        </Grid>

                                        <CollectionView
                                            Grid.Row="1"
                                            ItemsSource="{Binding Analysis.SupportResistance}"
                                            SelectionMode="None">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate x:DataType="models:SupportResistanceLevel">
                                                    <Grid
                                                        Padding="0,6"
                                                        ColumnDefinitions="Auto,*,Auto"
                                                        ColumnSpacing="12">
                                                        <Label StyleClass="bold" Text="{Binding Type}" />
                                                        <Label Grid.Column="1" Text="{Binding Price, StringFormat='${0:F2}'}" />
                                                        <Border
                                                            Grid.Column="2"
                                                            Background="{Binding Confidence, Converter={StaticResource ConfidenceToBrush}}"
                                                            StyleClass="ai-badge">
                                                            <Label StyleClass="ai-caption" Text="{Binding Confidence, StringFormat='{0:P0}'}" />
                                                        </Border>
                                                    </Grid>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                    </Grid>
                                </Border>

                                <!--  Indicators  -->
                                <Border
                                    Grid.Row="3"
                                    Grid.Column="0"
                                    StyleClass="ai-card">
                                    <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Border StyleClass="ai-iconchip">
                                                <Path Data="M6,7 H20 M4,7 A2,2 0 1 0 8,7 M10,13 H20 M8,13 A2,2 0 1 0 12,13" StyleClass="ai-icon" />
                                            </Border>
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="h4 ai-section-title"
                                                Text="Indicators" />
                                        </Grid>

                                        <FlexLayout
                                            Grid.Row="1"
                                            Margin="0,0,0,7"
                                            BindableLayout.ItemsSource="{Binding Analysis.Indicators}"
                                            Direction="Row"
                                            Wrap="Wrap">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate x:DataType="x:String">
                                                    <Border StyleClass="ai-tag">
                                                        <Label StyleClass="ai-caption" Text="{Binding .}" />
                                                    </Border>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </FlexLayout>
                                    </Grid>
                                </Border>

                                <!--  Risk  -->
                                <Border
                                    Grid.Row="3"
                                    Grid.Column="1"
                                    StyleClass="ai-card">
                                    <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Border StyleClass="ai-iconchip">
                                                <Path Data="M12,3 L20,6 V12 C20,16 16,19 12,21 C8,19 4,16 4,12 V6 Z" StyleClass="ai-icon" />
                                            </Border>
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="h4 ai-section-title"
                                                Text="Risk &amp; Volatility" />
                                        </Grid>
                                        <Label
                                            Grid.Row="1"
                                            StyleClass="ai-body"
                                            Text="{Binding Analysis.Risk}" />
                                    </Grid>
                                </Border>

                                <!--  Trade Idea  -->
                                <Border
                                    Grid.Row="4"
                                    Grid.ColumnSpan="2"
                                    StyleClass="ai-card">
                                    <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Border StyleClass="ai-iconchip">
                                                <Path Data="M12,4 A8,8 0 1 0 12,20 A8,8 0 1 0 12,4 M12,8 A4,4 0 1 0 12,16 A4,4 0 1 0 12,8" StyleClass="ai-icon" />
                                            </Border>
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="h4 ai-section-title"
                                                Text="AI Suggestion / Trade Idea" />
                                        </Grid>

                                        <Grid
                                            Grid.Row="1"
                                            ColumnDefinitions="*,*"
                                            ColumnSpacing="12"
                                            RowDefinitions="Auto,Auto,Auto"
                                            RowSpacing="6">
                                            <Label Text="Entry" />
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="bold"
                                                Text="{Binding Analysis.TradeIdea.Entry, StringFormat='${0:F2}'}" />

                                            <Label Grid.Row="1" Text="Stop Loss" />
                                            <Label
                                                Grid.Row="1"
                                                Grid.Column="1"
                                                StyleClass="bold"
                                                Text="{Binding Analysis.TradeIdea.StopLoss, StringFormat='${0:F2}'}" />

                                            <Label Grid.Row="2" Text="Targets" />
                                            <FlexLayout
                                                Grid.Row="2"
                                                Grid.Column="1"
                                                BindableLayout.ItemsSource="{Binding Analysis.TradeIdea.Targets}"
                                                Direction="Row"
                                                Wrap="Wrap">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="x:Double">
                                                        <Border StyleClass="ai-tag">
                                                            <Label Text="{Binding ., StringFormat='${0:F2}'}" />
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </FlexLayout>
                                        </Grid>

                                        <Label
                                            Grid.Row="2"
                                            StyleClass="ai-caption"
                                            Text="{Binding Analysis.TradeIdea.Rationale}" />
                                    </Grid>
                                </Border>

                                <!--  Explainability  -->
                                <Border
                                    Grid.Row="5"
                                    Grid.ColumnSpan="2"
                                    StyleClass="ai-card">
                                    <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <Border StyleClass="ai-iconchip">
                                                <Path Data="M12,4 A8,8 0 1 0 12,20 A8,8 0 1 0 12,4 M12,10 V16 M12,8 A1,1 0 1 0 12,8.01" StyleClass="ai-icon" />
                                            </Border>
                                            <Label
                                                Grid.Column="1"
                                                StyleClass="h4 ai-section-title"
                                                Text="Explainability" />
                                        </Grid>

                                        <!--  Now a single paragraph  -->
                                        <Label
                                            Grid.Row="1"
                                            LineBreakMode="WordWrap"
                                            StyleClass="ai-body"
                                            Text="{Binding Analysis.Explainability}" />
                                    </Grid>
                                </Border>


                            </Grid>
                        </ScrollView>

                        <!--  OVERLAY DOCK: placed last so it's always on top  -->
                        <Grid
                            Grid.Row="0"
                            Grid.RowSpan="2"
                            Margin="0,0,4,80"
                            ColumnDefinitions="Auto,12,Auto"
                            HorizontalOptions="End"
                            VerticalOptions="End"
                            ZIndex="9999">

                            <!--  background pill  -->
                            <Border
                                Grid.ColumnSpan="3"
                                StyleClass="ai-actionbar"
                                WidthRequest="148" />

                            <!--  Share  -->
                            <Border Grid.Column="0" StyleClass="ai-fab-ghost">
                                <Grid>
                                    <Path
                                        Data="M6,18 L18,6 M10,6 H18 V14"
                                        Stroke="{StaticResource Primary}"
                                        StyleClass="ai-fab-icon" />
                                </Grid>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ShareAnalysisCommand}" />
                                </Border.GestureRecognizers>
                            </Border>

                            <!--  Save  -->
                            <Border Grid.Column="2" StyleClass="ai-fab">
                                <Grid>
                                    <Path Data="M6,4 H18 V20 L12,16 L6,20 Z" StyleClass="ai-fab-icon" />
                                </Grid>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding SaveAnalysisCommand}" />
                                </Border.GestureRecognizers>
                            </Border>
                        </Grid>

                    </Grid>
                </bottomSheet:SfBottomSheet.BottomSheetContent>
            </bottomSheet:SfBottomSheet>


        </Grid>
        <!--  Busy overlay  -->
        <Grid
            x:Name="AnalyzingOverlay"
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            AbsoluteLayout.LayoutFlags="All"
            BackgroundColor="#66000000"
            InputTransparent="False"
            IsVisible="{Binding IsAnalyzing}"
            ZIndex="9999">

            <Grid
                Padding="18"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                WidthRequest="220">
                <Border
                    Padding="18"
                    Background="{StaticResource Brush.CardBgGradient}"
                    Shadow="{StaticResource Sh.CardShadow}"
                    StrokeShape="RoundRectangle 18">
                    <VerticalStackLayout HorizontalOptions="Center" Spacing="12">
                        <ActivityIndicator IsRunning="True" />
                        <Label
                            HorizontalTextAlignment="Center"
                            StyleClass="body"
                            Text="Analyzing chart…" />
                        <Label
                            FontSize="12"
                            HorizontalTextAlignment="Center"
                            Opacity="0.7"
                            Text="This may take a few seconds." />
                    </VerticalStackLayout>
                </Border>
            </Grid>
        </Grid>
        <Controls:TABBAR
            Margin="0,0,0,20"
            AbsoluteLayout.LayoutBounds="0.5,1,1,76"
            AbsoluteLayout.LayoutFlags="PositionProportional,WidthProportional"
            ZIndex="1000">
            <Controls:TABBAR.Triggers>
                <DataTrigger
                    Binding="{Binding IsAiSheetOpen}"
                    TargetType="Controls:TABBAR"
                    Value="True">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </Controls:TABBAR.Triggers>
        </Controls:TABBAR>
    </AbsoluteLayout>
</ContentPage>
